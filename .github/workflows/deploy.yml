name: Deploy a ProducciÃ³n

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Descargar cÃ³digo
        uses: actions/checkout@v4

      - name: Instalar dependencias del Servidor
        run: |
          cd server
          npm install

      - name: ğŸ—ï¸ Compilar el frontend
        run: |
          cd /var/www/siaf-patrimonio/client
          npm install
          CI=false npm run build

      - name: ğŸ” Restaurar permisos Nginx
        run: |
          sudo chown -R www-data:www-data /var/www/siaf-patrimonio/client/build

      - name: Desplegar archivos con rsync
        run: |
          # rsync sincroniza el cÃ³digo excluyendo archivos sensibles y carpetas de desarrollo
          rsync -av --delete \
            --exclude='.git' \
            --exclude='.env' \
            --exclude='node_modules' \
            --exclude='client/node_modules' \
            . /var/www/siaf-patrimonio/

      - name: Restaurar .env desde Backup (Si no existe)
        run: |
          # Solo copia el backup si por alguna razÃ³n el .env principal desapareciÃ³
          if [ ! -f /var/www/siaf-patrimonio/server/.env ]; then
            cp /var/www/.env.siaf-patrimonio /var/www/siaf-patrimonio/server/.env
          fi

      - name: Reiniciar Servidor Node.js
        run: |
          # Entramos a la carpeta final para asegurar que PM2 tome los cambios
          cd /var/www/siaf-patrimonio/server
          pm2 restart siaf-patrimonio --update-env || pm2 start src/index.js --name "siaf-patrimonio"
          echo "ğŸš€ Despliegue y Build finalizados con Ã©xito"