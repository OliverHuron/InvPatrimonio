name: ðŸš€ Deploy InvPatrimonio

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name:  Descargar cÃ³digo
        uses: actions/checkout@v4

      - name:  Instalar dependencias del servidor
        run: |
          cd server
          npm install --omit=dev

      - name:  Compilar el frontend
        run: |
          cd client
          npm install
          CI=false npm run build

      - name:  Desplegar archivos al servidor
        run: |
    
          rsync -av --delete \
            --exclude='server/uploads/' \
            --exclude='server/logs/' \
            --exclude='server/.env' \
            --exclude='node_modules/' \
            ./ /var/www/siaf-patrimonio/

      - name:  Restaurar .env
        run: |

          if [ ! -f /var/www/siaf-patrimonio/server/.env ]; then
            cp /var/www/.env.siaf-patrimonio /var/www/siaf-patrimonio/server/.env
          fi

      - name:  Permisos Nginx
        run: |
          sudo chown -R www-data:www-data /var/www/siaf-patrimonio/client/build

      - name:  Reiniciar PM2
        run: |
          pm2 restart siaf-patrimonio --update-env || pm2 start /var/www/siaf-patrimonio/server/src/index.js --name "siaf-patrimonio"
          pm2 save